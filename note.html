<!DOCTYPE html>
<html>

<head>
    <title></title>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="css/note.css"/>
    <script src="js/markdown-it.js"></script>

    <script>
        var md = window.markdownit();

        function update_note( id, title, keyword, txt ){
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "http://127.0.0.1:8081/daka/api/note/update", true)
            xhr.withCredentials = true;

            var req = {};
            req.id = id;
            req.title=title
            req.key_word=keyword
            req.txt = txt;
            xhr.send(JSON.stringify(req));

            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    var obj = JSON.parse(xhr.responseText)
                }
            }
        }

        function add_note_summary(obj){

            var note_id = obj.id;

            var note_txt = document.createElement('div')
            note_txt.setAttribute( "class", "note_txt" );
            note_txt.innerHTML = md.render( obj.txt );

            var note_keyword = document.createElement('div')
            note_keyword.setAttribute( "class", "note_keyword" );
            note_keyword.innerHTML = obj.key_word

            var note_date = document.createElement('div')
            note_date.setAttribute( "class", "note_date" );
            note_date.innerHTML = obj.last_update;

            var note_title_editor = document.createElement("input")
            var note_title = document.createElement('div')
            note_title.setAttribute( "class", "note_title" );
            note_title.innerHTML = obj.title;

            var note_view = document.createElement('div')
            note_view.setAttribute( "class", "note_view" );

            note_view.appendChild( note_title )
            note_view.appendChild( note_keyword )
            note_view.appendChild( note_date )
            note_view.appendChild( note_txt )

            var textarea = document.createElement('textarea')
            textarea.oninput = function (event) {
                note_txt.innerHTML = md.render( textarea.value );
            }

            var note_editor = document.createElement('div')
            note_editor.setAttribute( "class", "note_editor" );
            note_editor.appendChild( textarea )

            var note_item = document.createElement('div')
            note_item.setAttribute("class", "note_item")
            note_item.appendChild( note_editor )
            note_item.appendChild(note_view)

            note_editor.addEventListener("keyup", function (event) {
                if (event.code != "Escape") {
                    return
                }

                update_note( note_id, null, null, textarea.value );

                note_editor.style.display = "none"
                note_view.style.display = "block"
            })

            note_txt.addEventListener("dblclick", function () {
                note_editor.style.display = "block";
                note_view.style.display = "none"

                if( textarea.value == "" ){
                    textarea.value = obj.txt;
                }
            })

            document.getElementById("note_list").appendChild(note_item)
        }

        function get_my_note( id, editor ){
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "http://127.0.0.1:8081/daka/api/note/list", true)
            xhr.withCredentials = true;

            var req = {};
            req.note_id = id;
            xhr.send(JSON.stringify(req));

            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4 && xhr.status == 200) {

                    var obj = JSON.parse(xhr.responseText)

                    editor.value = obj.Data[0].txt;
                }
            }
        }

        function list_my_note(){

            var xhr = new XMLHttpRequest();
            xhr.open("GET", "http://127.0.0.1:8081/daka/api/note/list", true)
            xhr.withCredentials = true;
            xhr.send(null);

            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4 && xhr.status == 200) {

                    var obj = JSON.parse(xhr.responseText)

                    for (var item of obj.Data) {
                        add_note_summary( item )
                    }
                }
            }
        }

        function login() {
            var xhr = new XMLHttpRequest();
            xhr.withCredentials = true;
            xhr.open("POST", "http://127.0.0.1:8081/daka/api/login", true)
            xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded")
            // xhr.setRequestHeader( "Access-Control-Allow-Origin", "*" )
            xhr.send("name=123&password=123");

            xhr.onreadystatechange = function () {

                if (xhr.readyState == 4 && xhr.status == 200) {
                    list_my_note()
                }
            }
        }

        window.onload = function () {

            login()
        }

    </script>
</head>

<body>


<div class="wrapper">
    <header>I'm a 30px tall header</header>
    <main>
        <div class="wrapper_row">
            <div class="left">
                <div class="key_word">ySQL</div>
                <div class="key_word">数据库</div>
                <div class="key_word">oracle</div>
                <div class="key_word">Nginx</div>
                <div class="key_word">主从</div>
                <div class="key_word">Docker</div>
                <div class="key_word">Docker compuse</div>
                <div class="key_word">Golang</div>
                <div class="key_word">垃圾回收</div>
                <div class="key_word">c</div>
                <div class="key_word">算法</div>
                <div class="key_word">YAML</div>
                <div class="key_word">JSON</div>
            </div>
            <div class="right">

                <div class="note_list" id="note_list">
                </div>
            </div>
        </div>
    </main>
    <footer>I'm a 30px tall footer</footer>
</div>


</body>

</html>
