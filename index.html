<!DOCTYPE html>
<html>

<head>
    <title></title>
    <meta charset="utf-8">
    <!-- 引入 ECharts 文件 -->
    <!-- <script src="dist/echarts.min.js"></script> -->
    <link rel="stylesheet" type="text/css" href="css/1.css"/>
    <script src="js/mermaid.min.js"></script>
    <script>


        function list_daily_task() {

            var xhr = new XMLHttpRequest();
            xhr.open("GET", "http://127.0.0.1:8081/daka/api/daily/task/list", true)
            xhr.withCredentials = true;
            xhr.send(null);

            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4 && xhr.status == 200) {

                    var obj = JSON.parse(xhr.responseText)

                    for (var item of obj.Data) {
                        add_task(item.id, item.task_msg, item.task_date)
                    }
                }
            }
        }


        function get_task_txt(task_id, editor) {

            var xhr = new XMLHttpRequest();
            xhr.open("POST", "http://127.0.0.1:8081/daka/api/daily/task/list", true)
            xhr.withCredentials = true;

            var req = {};
            req.task_id = task_id;
            xhr.send(JSON.stringify(req));

            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4 && xhr.status == 200) {

                    var obj = JSON.parse(xhr.responseText)
                    editor.value = obj.Data[0].task_msg;
                }
            }
        }

        function set_task_txt(task_id, editor) {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "http://127.0.0.1:8081/daka/api/daily/task/set", true)
            xhr.withCredentials = true;

            var req = {};
            req.task_id = task_id;
            req.task_msg = editor.value;
            xhr.send(JSON.stringify(req));
        }

        function renderMermaid() {
            mermaid.init(undefined, document.querySelectorAll(".mermaid"));
        }

        function enable_gantt_edit(taskid, obj) {

            var old = obj.style.display

            if (old == "none" || old == "") {

                get_task_txt(taskid, obj.firstChild)
                obj.style.display = "block";


            } else {
                obj.style.display = "none"
            }
        }

        function DateDiffNow(sDate1) {    //sDate1和sDate2是2006-12-18格式

            var aDate, oDate1, oDate2, iDays
            oDate1 = new Date("2020-11-16");

            aDate = sDate1.split("-")
            oDate2 = new Date(aDate[0] + '-' + aDate[1] + '-' + aDate[2])
            iDays = parseInt(Math.abs(oDate1 - oDate2) / 1000 / 60 / 60 / 24) //把相差的毫秒数转换为天数

            return parseInt(iDays / 30) + "m " + iDays % 30 + "d"
        }

        function add_task(task_id, task_txt, task_date) {

            var mermaiddiv = document.createElement("div");
            mermaiddiv.setAttribute("class", "mermaid");
            mermaiddiv.textContent = task_txt;
            mermaiddiv.setAttribute("id", task_id)

            var btn = document.createElement("button");
            btn.setAttribute("type", "button")
            btn.setAttribute("onclick", "enable_gantt_edit(this.task_id,this.gannt_edit)")
            btn.innerText = "编辑"

            var divTitle = document.createElement("div")
            divTitle.setAttribute("class", "ganntTitle")
            divTitle.innerText = task_date + " " + DateDiffNow(task_date);

            var div1 = document.createElement("div")
            div1.style = "float:right;"

            div1.appendChild(btn)

            var rightDiv = document.createElement("div")
            rightDiv.appendChild(divTitle)
            rightDiv.appendChild(div1)
            rightDiv.appendChild(mermaiddiv)
            rightDiv.setAttribute("class", "right")

            var leftDiv = document.createElement("div")
            leftDiv.setAttribute("class", "gannt_edit left")

            leftDiv.addEventListener("keyup", function (event) {
                if (event.code != "Escape") {
                    return
                }

                leftDiv.style.display = "none"
            })

            var editor = document.createElement("textarea");

            editor.oninput = function (event) {
                set_task_txt(task_id, editor);

//                var element = document.getElementById( task_id )
//                var rst = mermaid.render(element.id, editor.value, function(svgCode,bindFunctions){
//                    console.log(svgCode)
//                    element.innerHTML = svgCode
//
//                    var newobj = document.createElement("div");
//                    newobj.setAttribute("class", "mermaid");
//                    newobj.innerHTML = svgCode;
//                    newobj.setAttribute("id", element.id)
//                    rightDiv.appendChild(newobj)
//                })

            }

            rightDiv.addEventListener("dblclick", function () {
                get_task_txt(task_id, editor)
                leftDiv.style.display = "block"
            })

            rightDiv.addEventListener("keyup", function (event) {
                if (event.code != "Escape") {
                    return
                }

                leftDiv.style.display = "none"
            })

            leftDiv.appendChild(editor)

            btn.gannt_edit = leftDiv;
            btn.task_id = task_id;

            var conDiv = document.createElement("div")
            conDiv.setAttribute("class", "gantt_item container")
            conDiv.appendChild(leftDiv)
            conDiv.appendChild(rightDiv)

            //document.getElementById("taskList").insertBefore(conDiv, document.getElementById("taskList").firstChild)

            document.getElementById("taskList").appendChild(conDiv)
            mermaid.init()
        }

        function login() {
            var xhr = new XMLHttpRequest();
            xhr.withCredentials = true;
            xhr.open("POST", "http://127.0.0.1:8081/daka/api/login", true)
            xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded")
            // xhr.setRequestHeader( "Access-Control-Allow-Origin", "*" )
            xhr.send("name=123&password=123");

            xhr.onreadystatechange = function () {

                if (xhr.readyState == 4 && xhr.status == 200) {
                    list_daily_task()
                }
            }
        }

        window.onload = function () {

            mermaid.initialize({
                startOnLoad: false,
                logLevel: 1,
                gantt: {
                    axisFormat: '%m/%d',
                }
            });

            login()
        }
    </script>

</head>

<body>
<div style="height: 30px"></div>
<div class="container">
    <div class="left" style="width: 30%"></div>
    <div class="gantt_body right">
        <div class="mermaid gantt_overall">
            gantt
            dateFormat YYYY-MM-DD
            excludes weekends
            axisFormat %m/%d

            section TiKV
            TiKV plan time : crit,done,2021-02-18,2021-03-15
            TiKV技术分享 : 2021-02-18,2d
            TiKV yaml调整 : 1d
            TiKV测试方案 : 3d
            TiKV备份方案 : 3d
            TiKV监控方案 : 3d

            section C++ SDK
            C++ SDK plan time : crit,done,2021-02-18,2021-03-10
            C++ SDK : 2021-02-18,10d
        </div>
        <div id="taskList" class="gantt_list">

        </div>

    </div>
</div>

</body>

</html>
